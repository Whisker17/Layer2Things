# 闪电网络（Lightning Network）

让我们把时间调回到 2017 年，由于 Bitcoin 的出块时间平均需要 10 分钟，同时每个区块的大小为 1

 M。那么每 10 分钟能打包的交易数量则为有限的，那么大家为了让自己的交易被打包确认的几率变大，只能不断地提高自己的交易费，于是就引发了一场对 Bitcoin 的扩容运动。主要由两方组成，一方希望做到的是链上扩容，比如加快出快的速度，或者扩大区块的大小，使其能够打包更多的交易，但是这两种方案都有自己无法避免的问题，这里先不展开去说。与此同时，有另一方想的是我们可以采取链下扩容的方案，于是**闪电网络**就应运而生了。

闪电网络是基于微支付通道衍生而来的，以 Bitcoin 作为结算基础，在链下实现了真正的点对点微支付交易。主要提出了**序列到期可撤销合约 RSMC**（Recoverable Sequence Maturity Contract）和**哈希时间锁定合约 HTLC**（Hashed Timelock Contract）。**前者解决了链下交易的确认问题，后者解决了支付通道的问题**。

## RSMC

闪电网络的基础是交易双方之间的双向微支付通道，RSMC 定义了该双向微支付通道的最基本工作方式。

举一个例子， Alice 和 Bob 如果需要借助闪电网络去进行转账，他们则需要分别往一个 2/2 签名的多重签名地址打入自己的币，比如各自打了 0.5 个 BTC。此时在 Bitcoin 的链上会产生一条交易记录通道打开时的状态，即 {Alice: 0.5 BTC , Bob: 0.5 BTC} 。之后，Alice 和 Bob 就可以进行一系列的转账，比如 Alice 给 Bob 打了 0.1 个 BTC，双方则需要对链下最新的分配结果 {Alice: 0.4 BTC , Bob: 0.6 BTC} 进行签名，同时签名作废之前的结果。如果 Alice 想要退出该通道。她可以像区块链 Commit 带有双方签名的余额结果，如果在一定的挑战期内 Bob 没有提出异议，那么区块链就会根据该结果将币转回到各自设置的提现地址。**如果 Bob 能在这段时间内提交证据证明 Alice 企图使用的是一个双方已同意作废的分配方案，则 Alice 的资金将被罚没并给到Bob 。** 为了鼓励双方尽可能久地利用通道进行交易，RSMC 对主动终止通道方给予了一定的惩罚：即**主动提出方其资金到账将比对方晚**。

## HTLC

如果 Alice 想和 Cathy 进行交易，但是她们俩之间并没有通道，与此同时 Alice 和 Bob 之间存在通道，Bob 和 Cathy 之间也存在通道，那我们是否可以通过这两个通道完成 Alice 和 Cathy 之间的链下交易呢？

这就是 HTLC 被提出的原因，我们可以通过智能合约，双方约定转账方先 Lock 一笔钱，并提供一个哈希值，如果在一定时间内有人能提出一个字符串，使得它哈希后的值跟已知值匹配（实际上意味着转账方授权了接收方来提现），则这笔钱转给接收方。

过程如下：

Alice 签名了一个转账密文 H 给 Cathy，由于 Alice 与 Cathy 之间没有直接的支付通道，Cathy 收不到这笔转账。现在，Alice 和 Bob 商定一个 HTLC 合约：只要 Bob 能在 2 天内向 Alice 出示正确的密文，Alice 则支付 Bob 0.1 BTC，否则钱会自动退还给 Alice 。

与此同时 Bob 和 Cathy 商定一个 HTLC 合约：只要 Cathy 能在 1 天内向 Bob 出示正确的密文，Bob 则支付 Cathy 0.09 BTC，否则钱会自动退还给 Bob。

现在，由于 Alice 已经把密文告诉了 Cathy，Cathy 只要向 Bob 出示正确的密文，就能收到 0.09 BTC。而多的 0.01 BTC 成了 Bob 的佣金，也可以理解为矿工费。

## Pros And Cons

首先我们要肯定闪电网络对于 Layer2 这个领域的先导作用，同时它也很好的完成了对于链下交易的基本功能的实现：

**优点**：

1. **非常低的 GAS 费**
2. **短确定时间**完成一笔 Bitcoin 交易。

**缺点**：

1. **网络的路由问题**
2. **中心化**的问题
3. **隐私的缺陷**
4. 由于锁定带来的**资产缩水**的风险