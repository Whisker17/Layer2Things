# Fucking Layer2

**一层解决不了的事情，那就再加一层来解决**

注：取这个标题并不是表达对 layer2 的不满，纯粹是为了致敬一下自己很喜欢的一个 github 的项目 `fucking-algorithm`

Bitcoin 和 Ethereum 作为最为人耳熟能详的两个区块链项目，为人诟病最多的便是其效率问题，同为金融产品，VISA 可以做到 1700 的 tps ，甚至理论上可以达到 24000 tps ，而 Bitcoin 的 tps 为 7 ，Ethereum 的 tps 则为 7-15 。Hello？请问你这些东西做出来的意义是什么呢？当然有！并且是对当前社会的组成形式的一种诉求与反抗，当然，这些东西并不会在这篇文章中体现出来。

我们可以设想一下，假设原本的一笔普通交易我们把它转化为一笔包含多笔普通交易的特殊交易，那么在一个区块里面所能打包的交易数量恒定的情况下，这样的措施是否就把原本的 tps 成倍数的增加了，这就呼应了文章开头的那句 `一层解决不了的事情，那就再加一层来解决` 。于是乎，聪明的 developers 纷纷想出了各种各样的 Layer2 方案，接下来我们就逐个进行介绍。



## 闪电网络（Lightning Network）

让我们把时间调回到 2017 年，由于 Bitcoin 的出块时间平均需要 10 分钟，同时每个区块的大小为 1

 M。那么每 10 分钟能打包的交易数量则为有限的，那么大家为了让自己的交易被打包确认的几率变大，只能不断地提高自己的交易费，于是就引发了一场对 Bitcoin 的扩容运动。主要由两方组成，一方希望做到的是链上扩容，比如加快出快的速度，或者扩大区块的大小，使其能够打包更多的交易，但是这两种方案都有自己无法避免的问题，这里先不展开去说。与此同时，有另一方想的是我们可以采取链下扩容的方案，于是**闪电网络**就应运而生了。

闪电网络是基于微支付通道衍生而来的，以 Bitcoin 作为结算基础，在链下实现了真正的点对点微支付交易。主要提出了**序列到期可撤销合约 RSMC**（Recoverable Sequence Maturity Contract）和**哈希时间锁定合约 HTLC**（Hashed Timelock Contract）。**前者解决了链下交易的确认问题，后者解决了支付通道的问题**。

### RSMC

闪电网络的基础是交易双方之间的双向微支付通道，RSMC 定义了该双向微支付通道的最基本工作方式。

举一个例子， Alice 和 Bob 如果需要借助闪电网络去进行转账，他们则需要分别往一个 2/2 签名的多重签名地址打入自己的币，比如各自打了 0.5 个 BTC。此时在 Bitcoin 的链上会产生一条交易记录通道打开时的状态，即 {Alice: 0.5 BTC , Bob: 0.5 BTC} 。之后，Alice 和 Bob 就可以进行一系列的转账，比如 Alice 给 Bob 打了 0.1 个 BTC，双方则需要对链下最新的分配结果 {Alice: 0.4 BTC , Bob: 0.6 BTC} 进行签名，同时签名作废之前的结果。如果 Alice 想要退出该通道。她可以像区块链 Commit 带有双方签名的余额结果，如果在一定的挑战期内 Bob 没有提出异议，那么区块链就会根据该结果将币转回到各自设置的提现地址。**如果 Bob 能在这段时间内提交证据证明 Alice 企图使用的是一个双方已同意作废的分配方案，则 Alice 的资金将被罚没并给到Bob 。** 为了鼓励双方尽可能久地利用通道进行交易，RSMC 对主动终止通道方给予了一定的惩罚：即**主动提出方其资金到账将比对方晚**。

### HTLC

如果 Alice 想和 Cathy 进行交易，但是她们俩之间并没有通道，与此同时 Alice 和 Bob 之间存在通道，Bob 和 Cathy 之间也存在通道，那我们是否可以通过这两个通道完成 Alice 和 Cathy 之间的链下交易呢？

这就是 HTLC 被提出的原因，我们可以通过智能合约，双方约定转账方先 Lock 一笔钱，并提供一个哈希值，如果在一定时间内有人能提出一个字符串，使得它哈希后的值跟已知值匹配（实际上意味着转账方授权了接收方来提现），则这笔钱转给接收方。

过程如下：

Alice 签名了一个转账密文 H 给 Cathy，由于 Alice 与 Cathy 之间没有直接的支付通道，Cathy 收不到这笔转账。现在，Alice 和 Bob 商定一个 HTLC 合约：只要 Bob 能在 2 天内向 Alice 出示正确的密文，Alice 则支付 Bob 0.1 BTC，否则钱会自动退还给 Alice 。

与此同时 Bob 和 Cathy 商定一个 HTLC 合约：只要 Cathy 能在 1 天内向 Bob 出示正确的密文，Bob 则支付 Cathy 0.09 BTC，否则钱会自动退还给 Bob。

现在，由于 Alice 已经把密文告诉了 Cathy，Cathy 只要向 Bob 出示正确的密文，就能收到 0.09 BTC。而多的 0.01 BTC 成了 Bob 的佣金，也可以理解为矿工费。

### Pros And Cons

首先我们要肯定闪电网络对于 Layer2 这个领域的先导作用，同时它也很好的完成了对于链下交易的基本功能的实现：

**优点**：

1. **非常低的 GAS 费**
2. **短确定时间**完成一笔 Bitcoin 交易。

**缺点**：

1. **网络的路由问题**
2. **中心化**的问题
3. **隐私的缺陷**
4. 由于锁定带来的**资产缩水**的风险

## 状态通道（State Channel）

状态通道技术，受启发于比特币的闪电网络。**状态通道是固定一组参与者（通常是两名参与者）之间的协议，用以实现安全的链下交易，其中支付通道专门用来支付**。状态通道是支付通道更为普遍的形式——它们不仅可以处理支付，也可以处理区块链的“状态更新”——就像智能合约的更改。

### Pros And Cons

**优点**：

1. **交互延迟在毫秒级别**
2. **交易手续费极低**
3. **水平扩展性强**；加节点就能增加总系统容量，TPS 无上限，且互相之间不隔离，不需要有跨分片或者跨链之类的复杂操作。

**缺点**：

1. 由于存在挑战期，退出无法做到即时性。
2. **资金利用率低**；**状态通道是要这个双方都把这个钱存到链上的通道，之后再互相进行发送支付**。**如果一个用户给另一个用户发送一大笔钱，那中间每一个转发的节点都要有这么大的容量，在现实生活中是不太可能的**。
3. **状态机只适用于这个固定的人数**。所以把一般的 dApp 迁移到状态通道中是相当困难的。即使你把棋类游戏或是稍大的 PC 游戏搬到状态通道上，这些游戏也必须写成状态机的形式。**他们每一个状态的转移，要非常清楚地写出来**。

## 侧链（Side Chain）

**侧链的本质就是在基础层上再搭一个链，然后用完全另外一套验证人**。它的整个安全性是分开的：**主链有主链的安全性，侧链有侧链的安全性**，是一种跨区块链的解决方案。

通过这种解决方案，可以实现数字资产从第一个区块链到第二个区块链的转移，又可以在稍后的时间点从第二个区块链安全返回到第一个区块链。侧链通过**双向挂钩**连接到一个基础层协议。由于没有第一层设计的负担，**侧链可以支持超出其基础层能力的某些特性，包括但不限于可扩展性和互操作性，同时不依赖于第一层的存储**。

侧链会通过**选择性地将区块头的 snapshot 发送回主链**从而避免分叉导致的作恶行为。侧链上的分叉选择遵循一个原则：**合法的链必须构建在最近一个进行过 snapshot 的区块之上** 。对于状态通道来说，其安全性就是双方互相签过名，就具备主链的安全性。只要一方做恶，另外一方都可以提交到主链，把它这个争议解决掉。而侧链的话就是你要信任多数的验证人是好人，所以它的安全性要比主链低很多。

### 无效状态转移

由于侧链并不会将所有在侧链生成的区块返回到主链去进行验证（否则就没有做侧链的意义了），那么如果有超过 50% 或 66%（取决于侧链的架构）的验证者串谋的话，他们可以创建一个完全无效的区块，窃取其他参与者的资产，并将这个区块的 snapshot 发送至主链，发起并完成一个退出交易，就可以成功偷走这些资产。

### Pros And Cons

**优点**：

1. 侧链的延迟是相对低的，比状态通道的毫秒级高一些，比主链的十几秒几十秒延迟低很多。
2. 代码和数据独立，不增加主链的负担。

**缺点**：

1. **安全性稍弱**

## Plasma



## Rollup